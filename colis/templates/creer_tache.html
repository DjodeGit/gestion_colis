<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créer une Tâche</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
    <section id="tache" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-12">Créer une Tâche</h2>
            <div class="max-w-2xl mx-auto bg-gray-50 p-8 rounded-lg shadow-md">
                <form id="tache-form">
                    <div class="mb-6">
                        <label for="description" class="block text-gray-700 mb-2">Description de la tâche</label>
                        <textarea id="description" name="description" rows="5" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="transporteur" class="block text-gray-700 mb-2">Transporteur</label>
                        <select id="transporteur" name="transporteur" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Choisir un transporteur</option>
                            <!-- Options remplies via JavaScript -->
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="status" class="block text-gray-700 mb-2">Statut</label>
                        <select id="status" name="status" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="pending">En attente</option>
                            <option value="in_progress">En cours</option>
                            <option value="done">Terminé</option>
                        </select>
                    </div>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                        Créer la Tâche
                    </button>
                </form>
                <div id="form-message" class="mt-4 text-center"></div>
            </div>
        </div>
    </section>

    <script>
        // Charger la liste des transporteurs depuis l'API
        async function loadTransporteurs() {
            try {
                const response = await fetch('http://localhost:8000/api/transporteurs/', {
                    headers: {
                        'Authorization': 'Token YOUR_TOKEN_HERE'  // Remplace par le token de l'Agent
                    }
                });
                if (!response.ok) throw new Error('Erreur lors du chargement des transporteurs');
                const transporteurs = await response.json();
                const select = document.getElementById('transporteur');
                transporteurs.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    option.text = t.name;
                    select.appendChild(option);
                });
            } catch (error) {
                document.getElementById('form-message').innerHTML = '<p class="text-red-600">Erreur : ' + error.message + '</p>';
            }
        }

        // Charger les transporteurs au démarrage
        loadTransporteurs();

        // Gérer la soumission du formulaire
        document.getElementById('tache-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = {
                description: formData.get('description'),
                transporteur: formData.get('transporteur'),
                status: formData.get('status')
            };

            try {
                const response = await fetch('http://localhost:8000/api/taches/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                       //'Authorization': 'Token 876147871068a6ff62d512d895c3770c00c88a73'  // Remplace par le token de l'Agent
                        'Authorization': 'Token 2ead5b21423987111d98607c7e42d6b931ccf596 '
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                const messageDiv = document.getElementById('form-message');
                if (response.ok) {
                    messageDiv.innerHTML = '<p class="text-green-600">Tâche créée avec succès !</p>';
                    form.reset();
                } else {
                    messageDiv.innerHTML = '<p class="text-red-600">Erreur : ' + result.error + '</p>';
                }
            } catch (error) {
                document.getElementById('form-message').innerHTML = '<p class="text-red-600">Erreur : ' + error.message + '</p>';
            }
        });
    </script>
</body>
</html>